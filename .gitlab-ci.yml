image: node:12-alpine

.deploy: &deploy
  - echo API_URL=$API_URL >> .env.production
  - echo API_KEY_MAPS=$API_KEY_MAPS >> .env.production
  - echo VUE_APP_ACCESS_KEY_ID=$VUE_APP_ACCESS_KEY_ID >> .env.production
  - echo VUE_APP_BUCKET_NAME=$VUE_APP_BUCKET_NAME >> .env.production
  - echo VUE_APP_DIR_NAME=$VUE_APP_DIR_NAME >> .env.production
  - echo VUE_APP_REGION=$VUE_APP_REGION >> .env.production
  - echo VUE_APP_S3_URL=$VUE_APP_S3_URL >> .env.production
  - echo VUE_APP_SECRET_ACCESS_KEY=$VUE_APP_SECRET_ACCESS_KEY >> .env.production
  - echo VUE_WS_DOMAIN=$VUE_WS_DOMAIN >> .env.production

  - npm install -g firebase-tools
  - npm install -g @quasar/cli
  - npm install

stages:
  - testing
  - production

testing:
  stage: testing
  before_script:
    - *deploy
  only:
    - develop
  environment:
    name: develop
  variables:
    ENVIRONMENT: develop
  script:
    - npm run build-pwa
    - firebase use ikiero-test --token $FIREBASE_TOKEN_TEST
    - firebase deploy -m "Pipe $CI_PIPELINE_ID Build $CI_BUILD_ID" --only hosting:domis-test --non-interactive --token $FIREBASE_TOKEN_TEST

production:
  stage: production
  before_script:
    - *deploy
  only:
    - master
  environment:
    name: production
  variables:
    ENVIRONMENT: production
  script:
    - npm run build-pwa
    - firebase use ikiero --token $FIREBASE_TOKEN
    - firebase deploy -m "Pipe $CI_PIPELINE_ID Build $CI_BUILD_ID" --only hosting:domis-prod --non-interactive --token $FIREBASE_TOKEN
